<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How Many Trades Do You Need?</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 20px;
            color: #1a1a1a;
            position: relative;
        }

        .attribution {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 12px;
            color: #999;
            z-index: 10;
        }

        .attribution a {
            color: #1a1a1a;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .attribution a:hover {
            opacity: 0.7;
            text-decoration: underline;
        }

        .attribution .heart {
            display: inline-block;
            font-style: normal;
        }

        .nav-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .nav-menu a {
            color: #1a1a1a;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: white;
            transition: all 0.2s;
            display: inline-block;
        }

        .nav-menu a:hover {
            background: #fafafa;
            border-color: #1a1a1a;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fafafa;
            border-radius: 0;
            border: none;
            overflow: hidden;
        }

        .header {
            background: #fafafa;
            color: #1a1a1a;
            padding: 48px 32px;
            text-align: center;
            border-bottom: none;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 600;
            letter-spacing: -0.02em;
            line-height: 1.4;
        }

        .header p {
            font-size: 16px;
            color: #666;
            font-weight: 400;
        }

        .content {
            padding: 0px 32px 40px 32px;
            background: #fafafa;
        }

        .calculator {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1a1a1a;
            font-size: 14px;
        }

        .input-with-suffix {
            position: relative;
            width: 100%;
        }

        .input-with-suffix input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d1d1;
            border-radius: 6px;
            font-size: 15px;
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-suffix {
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 15px;
            pointer-events: none;
            user-select: none;
            transition: left 0.1s;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d1d1;
            border-radius: 6px;
            font-size: 15px;
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-with-suffix input:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .form-group input[type="number"]::placeholder {
            color: #999;
        }

        .form-group .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            line-height: 1.5;
        }

        .help-icon-container {
            display: inline-block;
            position: relative;
            margin-left: 6px;
            vertical-align: middle;
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid #d1d1d1;
            color: #666;
            font-size: 12px;
            font-weight: 600;
            cursor: help;
            transition: all 0.2s;
        }

        .help-icon:hover {
            border-color: #1a1a1a;
            color: #1a1a1a;
            background: #fafafa;
        }

        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 16px;
            background: #1a1a1a;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            white-space: normal;
            width: 280px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            font-weight: 400;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1a1a1a;
        }

        .help-icon-container:hover .tooltip {
            opacity: 1;
            pointer-events: auto;
        }

        .confidence-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .confidence-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d1d1d1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            color: #1a1a1a;
        }

        .confidence-btn:hover {
            border-color: #1a1a1a;
            background: #fafafa;
        }

        .confidence-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }

        .toggle-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1a1a1a;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .result {
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            margin-top: 24px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result .number {
            font-size: 48px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 12px 0;
            letter-spacing: -0.02em;
        }

        .result .label {
            font-size: 15px;
            color: #666;
        }

        .result .no-edge-title {
            font-size: 32px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .result .no-edge-subtitle {
            font-size: 15px;
            color: #666;
        }

        .calculate-btn {
            width: 100%;
            padding: 12px 24px;
            background: #1a1a1a;
            color: white;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            margin-top: 24px;
        }

        .calculate-btn:hover {
            background: #333;
            border-color: #333;
        }

        .calculate-btn:active {
            transform: scale(0.98);
        }

        .section {
            margin-top: 50px;
        }

        .section h2 {
            font-size: 22px;
            margin-bottom: 24px;
            color: #1a1a1a;
            font-weight: 600;
            letter-spacing: -0.01em;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 12px;
        }

        .qa-item {
            margin-bottom: 24px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 24px;
        }

        .qa-item h3 {
            font-size: 17px;
            color: #1a1a1a;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .qa-item p {
            line-height: 1.6;
            color: #666;
            font-size: 15px;
        }

        .qa-item ul {
            margin-left: 20px;
            margin-top: 12px;
        }

        .qa-item li {
            margin-bottom: 8px;
            line-height: 1.6;
            color: #666;
            font-size: 15px;
        }

        .qa-item a {
            color: #1a1a1a;
            text-decoration: underline;
            font-weight: 500;
        }

        .qa-item a:hover {
            text-decoration: underline;
        }

        .warning-box {
            background: white;
            border: 1px solid #e5e5e5;
            border-left: 3px solid #1a1a1a;
            padding: 20px 24px;
            border-radius: 8px;
            margin-top: 32px;
        }

        .warning-box h3 {
            color: #1a1a1a;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .warning-box p {
            color: #666;
            line-height: 1.6;
            font-size: 15px;
        }

        .warning-box a {
            color: #1a1a1a;
            text-decoration: underline;
            font-weight: 500;
        }

        .warning-box a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 24px;
            }

            .confidence-options {
                flex-direction: column;
            }

            .result .number {
                font-size: 36px;
            }

            .tooltip {
                width: 240px;
                font-size: 12px;
                padding: 10px 14px;
            }

            .attribution {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="attribution">
        made with <span class="heart">❤️</span> by <a href="https://stonkscapital.substack.com/" target="_blank">stonks capital</a>
    </div>
    <div class="nav-menu">
        <a href="monte-carlo.html">Monte Carlo</a>
    </div>
    <div class="container">
        <div class="header">
            <h1>Backtest Sample Size Calculator</h1>
            <p>How many trades do you actually need to know your strategy is legit?</p>
        </div>

        <div class="content">
            <div class="calculator">
                <div class="form-group">
                    <label for="winrate">
                        Win Rate
                        <span class="help-icon-container">
                            <span class="help-icon">
                                ?
                                <span class="tooltip">Enter as percentage (e.g., 25 for 25%)</span>
                            </span>
                        </span>
                    </label>
                    <div class="input-with-suffix">
                        <input type="number" id="winrate" min="0" max="100" step="1" placeholder="25" value="25">
                        <span class="input-suffix">%</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="rr">
                        Risk-Reward Ratio
                        <span class="help-icon-container">
                            <span class="help-icon">
                                ?
                                <span class="tooltip">Enter as ratio (e.g., 4 for 1:4 risk-reward)</span>
                            </span>
                        </span>
                    </label>
                    <input type="number" id="rr" min="0.1" step="0.1" placeholder="4.0" value="4.0">
                </div>

                <div class="form-group">
                    <label>Confidence Level</label>
                    <div class="confidence-options">
                        <div class="confidence-btn active" data-conf="0.95">95%</div>
                        <div class="confidence-btn" data-conf="0.99">99%</div>
                        <div class="confidence-btn" data-conf="0.999">99.9%</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Calculation Mode</label>
                    <div class="confidence-options">
                        <div class="confidence-btn mode-btn active" data-mode="estimation">Edge Estimation</div>
                        <div class="confidence-btn mode-btn" data-mode="detection">Edge Detection</div>
                    </div>
                    <div class="help-text">
                        <span id="mode-description">Estimate your EV accurately for position sizing</span>
                    </div>
                </div>

                <div class="form-group" id="ev-direction-group" style="display: none;">
                    <label>Test Direction</label>
                    <div class="toggle-container">
                        <span class="toggle-label">EV > 0</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ev-direction-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">EV < 0</span>
                    </div>
                    <div class="help-text">
                        <span id="direction-description">Test if your strategy has positive expected value</span>
                    </div>
                </div>

                <div class="form-group" id="params-group" style="display: none;">
                    <label for="params">
                        Parameters Optimized - Optional
                        <span class="help-icon-container">
                            <span class="help-icon">
                                ?
                                <span class="tooltip">The number of parameter combinations you tested and picked the best from. For example: testing 5 different RSI thresholds and picking the best = 5 parameters. If you didn't optimize anything, leave as 0.</span>
                            </span>
                        </span>
                    </label>
                    <input type="number" id="params" min="0" step="1" placeholder="0" value="0">
                </div>

                <div class="form-group" id="ci-width-group" style="display: none;">
                    <label for="ci-width">
                        Desired Confidence Interval Width - Optional
                        <span class="help-icon-container">
                            <span class="help-icon">
                                ?
                                <span class="tooltip">The margin of error as a percentage of your EV. For example, 30 means your EV estimate will be within ±30% of the true value. Smaller values require more trades.</span>
                            </span>
                        </span>
                    </label>
                    <div class="input-with-suffix">
                        <input type="number" id="ci-width" min="1" max="100" step="1" placeholder="30" value="30">
                        <span class="input-suffix">%</span>
                    </div>
                    <div class="help-text">Leave empty to see Confidence Interval width for current number of trades</div>
                </div>

                <div class="form-group" id="num-trades-group" style="display: none;">
                    <label for="num-trades">
                        Number of Trades in Your Backtest - Optional
                        <span class="help-icon-container">
                            <span class="help-icon">
                                ?
                                <span class="tooltip">Enter the actual number of trades you have. We'll calculate the confidence interval for your EV estimate.</span>
                            </span>
                        </span>
                    </label>
                    <input type="number" id="num-trades" min="1" step="1" placeholder="e.g., 100">
                </div>

                <button class="calculate-btn" onclick="calculate()">Calculate</button>

                <div id="result" class="result">
                    <div id="result-content">
                        <div class="label">You need approximately</div>
                        <div class="number" id="result-number">0</div>
                        <div class="label" id="result-label">trades in your backtest</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>How to Use the Tool?</h2>

                <div class="qa-item">
                    <h3>What questions does this tool answer?</h3>
                    <p><strong>Edge Detection:</strong> "How many trades do I need to know my strategy has a real edge (EV > 0) and it's not just luck?"</p>
                    <p><strong>Edge Estimation (Sizing):</strong> "How many trades do I need to accurately estimate my EV for position sizing decisions?"</p>
                    <p>This tool uses rigorous statistical methods to answer both questions. Edge Detection requires fewer trades (just to confirm you have an edge), while Edge Estimation requires more trades (to precisely quantify that edge for sizing).</p>
                </div>

                <div class="qa-item">
                    <h3>What's the difference between Edge Detection and Edge Estimation?</h3>
                    <p><strong>Edge Detection:</strong> Tests whether your strategy is profitable (EV > 0). This is useful for validating that your backtest results aren't just random chance. Uses Bonferroni correction to account for parameter optimization.</p>
                    <p><strong>Edge Estimation (Sizing):</strong> Estimates your EV with a specific precision (confidence interval). This is essential for position sizing methods like Kelly Criterion or fixed fractional sizing. Requires significantly more trades than detection alone.</p>
                    <p><strong>Example:</strong> With 30 trades, you might be 95% confident you have an edge (EV > 0), but you'd need 500-1000+ trades to know your EV is 0.25 ± 0.05 with 95% confidence for sizing decisions.</p>
                </div>

                <div class="qa-item">
                    <h3>How does it work?</h3>
                    <p>The calculation uses:</p>
                    <ul>
                        <li><strong>Central Limit Theorem:</strong> Models your strategy's returns as a statistical distribution</li>
                        <li><strong>Expected Value (EV):</strong> Calculates if your strategy is profitable: EV = (winrate × RR) - (1 - winrate)</li>
                        <li><strong>Variance:</strong> Measures uncertainty in your results</li>
                        <li><strong>Confidence Intervals:</strong> For detection, ensures you're confident EV > 0. For estimation, provides a range for your EV estimate.</li>
                        <li><strong>Bonferroni Correction:</strong> (Edge Detection only) Adjusts for multiple parameter testing to prevent false positives</li>
                    </ul>
                </div>

                <div class="qa-item">
                    <h3>When should I use Edge Detection vs. Edge Estimation?</h3>
                    <p><strong>Use Edge Detection when:</strong></p>
                    <ul>
                        <li>You want to validate that your backtest results show a real edge (not just luck)</li>
                        <li>You're deciding whether to proceed with a strategy</li>
                        <li>You want the minimum number of trades needed for statistical confidence</li>
                    </ul>
                    <p><strong>Use Edge Estimation when:</strong></p>
                    <ul>
                        <li>You need to accurately estimate your EV for position sizing (Kelly Criterion, fixed fractional, etc.)</li>
                        <li>You want to know the precision of your EV estimate</li>
                        <li>You're making sizing decisions based on your backtest results</li>
                    </ul>
                    <p><strong>Remember:</strong> Edge Estimation requires significantly more trades than Edge Detection. You might confirm an edge exists with 100 trades, but need 1,000+ trades to size positions accurately.</p>
                </div>

                <div class="qa-item">
                    <h3>Why do I need more trades when I optimize parameters?</h3>
                    <p>Every time you test different parameter combinations and pick the best, you increase the chance of finding a false positive. This is called the "multiple testing problem" or "data snooping bias."</p>
                    <p>Example: If you test 10 different RSI thresholds, one might look great by pure luck. The Bonferroni correction accounts for this by making the test more stringent.</p>
                    <p><strong>Note:</strong> Parameter optimization affects Edge Detection (uses Bonferroni correction) but not Edge Estimation (which estimates a single parameter).</p>
                </div>

                <div class="qa-item">
                    <h3>What makes a strategy need more trades?</h3>
                    <p>The required number of trades increases when:</p>
                    <ul>
                        <li><strong>Mode selection:</strong> Edge Estimation requires more trades than Edge Detection (precision vs. detection)</li>
                        <li><strong>Desired precision:</strong> Smaller Confidence Interval widths (e.g., ±5% vs. ±15%) require more trades</li>
                        <li><strong>Asymmetric risk-reward:</strong> High RR ratios create more variance</li>
                        <li><strong>Low win rate:</strong> Fewer wins means more uncertainty</li>
                        <li><strong>Fat-tailed distribution:</strong> Rare big wins increase variance</li>
                        <li><strong>Many parameters optimized:</strong> (Edge Detection only) More testing = higher false positive risk</li>
                    </ul>
                </div>

                <div class="qa-item">
                    <h3>Is this method academically sound?</h3>
                    <p>Yes! This approach is based on:</p>
                    <ul>
                        <li>White's Reality Check (multiple hypothesis testing)</li>
                        <li>Hansen SPA test methods</li>
                        <li>Multiple comparison corrections used in scientific research</li>
                        <li>Lo & MacKinlay (1990) on data-snooping in finance</li>
                        <li>Standard practice in professional quant firms and academic papers</li>
                    </ul>
                    <p>For a detailed mathematical derivation of the formula, <a href="https://stonkscapital.substack.com/p/the-mathematics-of-backtest-validation" target="_blank">read more here</a>.</p>
                </div>

                <div class="qa-item">
                    <h3>How do I interpret the result?</h3>
                    <p><strong>Edge Detection Mode:</strong></p>
                    <p id="interpretation-example">If the tool says you need 553 trades, it means:</p>
                    <p id="interpretation-main"><strong>With 553 trades in your backtest, you can be 95% confident (or your chosen confidence level) that your observed edge is real and not due to random chance or overfitting.</strong></p>
                    <p id="interpretation-note">If your backtest has fewer trades, the result may not be reliable. The more parameters you optimized, the more trades you need to be confident.</p>
                    <p style="margin-top: 16px;"><strong>Edge Estimation Mode:</strong></p>
                    <p>If you enter your number of trades, you'll see your EV estimate with a confidence interval. The Confidence Interval width shows how precise your estimate is. A wide Confidence Interval (shown with a warning) means you need more trades for reliable sizing decisions.</p>
                    <p>If you enter a desired Confidence Interval width (e.g., ±15%), the tool calculates how many trades you need to achieve that precision. Smaller Confidence Interval widths require more trades.</p>
                </div>

                <div class="warning-box">
                    <h3>⚠️ What Could Still Go Wrong?</h3>
                    <p>
                        Even with sufficient trades for statistical confidence, other factors can affect your strategy's viability. 
                        Learn about additional risks, limitations, and real-world considerations in our 
                        <a href="https://stonkscapital.substack.com/p/the-backtest-checklist-7-things-you" target="_blank">comprehensive blog post on backtesting pitfalls</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedConfidence = 0.95;
        let hasCalculated = false;
        let calculationMode = 'estimation'; // 'detection' or 'estimation'
        let evDirection = 'positive'; // 'positive' for EV > 0 (circle left), 'negative' for EV < 0 (circle right)

        // Mode button handlers
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                calculationMode = btn.dataset.mode;
                
                // Show/hide relevant fields
                const ciWidthGroup = document.getElementById('ci-width-group');
                const numTradesGroup = document.getElementById('num-trades-group');
                const paramsGroup = document.getElementById('params-group');
                const evDirectionGroup = document.getElementById('ev-direction-group');
                const modeDescription = document.getElementById('mode-description');
                
                if (calculationMode === 'estimation') {
                    ciWidthGroup.style.display = 'block';
                    numTradesGroup.style.display = 'block';
                    paramsGroup.style.display = 'none';
                    evDirectionGroup.style.display = 'none';
                    modeDescription.textContent = 'Estimate your EV accurately for position sizing';
                } else {
                    ciWidthGroup.style.display = 'none';
                    numTradesGroup.style.display = 'none';
                    paramsGroup.style.display = 'block';
                    evDirectionGroup.style.display = 'block';
                    updateModeDescription();
                }
                
                // Auto-calculate if user has already calculated once
                if (hasCalculated) {
                    calculate();
                }
            });
        });

        // EV Direction toggle handler
        // Note: unchecked (circle left) = EV > 0, checked (circle right) = EV < 0
        const evDirectionToggle = document.getElementById('ev-direction-toggle');
        if (evDirectionToggle) {
            evDirectionToggle.addEventListener('change', (e) => {
                evDirection = e.target.checked ? 'negative' : 'positive';
                updateModeDescription();
                
                // Auto-calculate if user has already calculated once
                if (hasCalculated) {
                    calculate();
                }
            });
        }

        function updateModeDescription() {
            const modeDescription = document.getElementById('mode-description');
            const directionDescription = document.getElementById('direction-description');
            if (calculationMode === 'detection') {
                if (evDirection === 'positive') {
                    modeDescription.textContent = 'Detect if you have an edge (EV > 0)';
                    directionDescription.textContent = 'Test if your strategy has positive expected value';
                } else {
                    modeDescription.textContent = 'Detect if trades have negative edge (EV < 0)';
                    directionDescription.textContent = 'Test if specific trades have negative expected value (for removal/validation)';
                }
            }
        }

        function updateInterpretation(numTrades, confidence) {
            const confidencePercent = Math.round(confidence * 100);
            const interpretationExample = document.getElementById('interpretation-example');
            const interpretationMain = document.getElementById('interpretation-main');
            
            if (interpretationExample && interpretationMain) {
                const directionText = evDirection === 'positive'
                    ? 'that your observed edge is real and not due to random chance or overfitting'
                    : 'that these trades have negative edge and can be safely removed';
                
                interpretationExample.textContent = `If the tool says you need ${numTrades.toLocaleString()} trades, it means:`;
                interpretationMain.innerHTML = `<strong>With ${numTrades.toLocaleString()} trades in your backtest, you can be ${confidencePercent}% confident (or your chosen confidence level) ${directionText}.</strong>`;
            }
        }

        // Confidence button handlers
        document.querySelectorAll('.confidence-btn:not(.mode-btn)').forEach(btn => {
            btn.addEventListener('click', () => {
                // Only handle confidence buttons, not mode buttons
                if (btn.classList.contains('mode-btn')) return;
                
                document.querySelectorAll('.confidence-btn:not(.mode-btn)').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedConfidence = parseFloat(btn.dataset.conf);
                // Auto-calculate if user has already calculated once
                if (hasCalculated) {
                    calculate();
                }
            });
        });

        function calculate() {
            const winratePercent = parseFloat(document.getElementById('winrate').value);
            const rr = parseFloat(document.getElementById('rr').value);
            const params = parseInt(document.getElementById('params').value) || 1; // Default to 1 if 0
            
            // Validation
            if (isNaN(winratePercent) || winratePercent <= 0 || winratePercent >= 100) {
                alert('Please enter a valid win rate between 0 and 100 (e.g., 25 for 25%)');
                return;
            }
            
            if (isNaN(rr) || rr <= 0) {
                alert('Please enter a valid risk-reward ratio (e.g., 4 for 1:4)');
                return;
            }

            // Convert percentage to decimal for calculations
            const winrate = winratePercent / 100;

            // Calculate break-even win rate
            const p0 = 1 / (1 + rr);

            // Check edge direction based on mode and direction setting
            if (calculationMode === 'detection') {
                if (evDirection === 'positive') {
                    // Testing EV > 0: check if winrate is above break-even
                    if (winrate <= p0) {
                        const resultDiv = document.getElementById('result');
                        resultDiv.innerHTML = '<div class="no-edge-title">You have no edge</div><div class="no-edge-subtitle">Your strategy is -EV, back to drawing board</div>';
                        resultDiv.classList.add('show');
                        hasCalculated = true;
                        return;
                    }
                } else {
                    // Testing EV < 0: check if winrate is below break-even
                    if (winrate >= p0) {
                        const resultDiv = document.getElementById('result');
                        resultDiv.innerHTML = '<div class="no-edge-title">Trades are not -EV</div><div class="no-edge-subtitle">These trades have positive or zero EV, cannot validate removal</div>';
                        resultDiv.classList.add('show');
                        hasCalculated = true;
                        return;
                    }
                }
            } else {
                // Estimation mode: check if winrate is above break-even
                if (winrate <= p0) {
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = '<div class="no-edge-title">You have no edge</div><div class="no-edge-subtitle">Your strategy is -EV, back to drawing board</div>';
                    resultDiv.classList.add('show');
                    hasCalculated = true;
                    return;
                }
            }

            // Calculate z-score using inverse normal CDF
            // Approximates scipy.stats.norm.ppf(1 - alphaAdj)
            function normPPF(p) {
                // Welford's approximation for inverse normal CDF
                if (p <= 0) return -Infinity;
                if (p >= 1) return Infinity;
                if (p === 0.5) return 0;
                
                // Rational approximation for standard normal quantile
                const sign = p < 0.5 ? -1 : 1;
                p = p < 0.5 ? p : 1 - p;
                
                const t = Math.sqrt(-2.0 * Math.log(p));
                const c0 = 2.515517;
                const c1 = 0.802853;
                const c2 = 0.010328;
                const d1 = 1.432788;
                const d2 = 0.189269;
                const d3 = 0.001308;
                
                const num = c0 + c1 * t + c2 * t * t;
                const den = 1 + d1 * t + d2 * t * t + d3 * t * t * t;
                
                return sign * (t - num / den);
            }
            
            // For detection: use Bonferroni-adjusted alpha (multiple testing)
            // For estimation: use regular alpha (single parameter estimation)
            const alpha = 1 - selectedConfidence;
            let z;
            if (calculationMode === 'detection') {
                const alphaAdj = alpha / params;
                z = normPPF(1 - alphaAdj);
            } else {
                // Estimation: no Bonferroni correction (estimating single parameter)
                z = normPPF(1 - alpha / 2); // Two-tailed for Confidence Interval
            }

            // Calculate variance (binomial variance term - matching Python implementation)
            // Using p * (1 - p) as in the Python code
            const variance = winrate * (1 - winrate);

            // Effect size (delta)
            // For EV > 0: delta = winrate - p0 (positive)
            // For EV < 0: delta = p0 - winrate (positive, since winrate < p0)
            const delta = evDirection === 'positive' ? (winrate - p0) : (p0 - winrate);

            // Calculate EV
            const EV = winrate * rr - (1 - winrate);
            
            let n, resultHTML;
            
            if (calculationMode === 'detection') {
                // Edge Detection: Required sample size: n = (z^2 * variance) / delta^2
                n = Math.ceil((z * z * variance) / (delta * delta));
                
                const directionText = evDirection === 'positive' 
                    ? 'This tests if EV > 0 (you have an edge).' 
                    : 'This tests if EV < 0 (trades have negative edge, safe to remove).';
                const labelText = evDirection === 'positive'
                    ? 'trades to detect an edge'
                    : 'trades to validate negative edge';
                
                resultHTML = `
                    <div class="label">You need approximately</div>
                    <div class="number" id="result-number">${n.toLocaleString()}</div>
                    <div class="label" id="result-label">${labelText}</div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5; font-size: 14px; color: #666;">
                        ${directionText} For accurate EV estimation for sizing, use "Edge Estimation" mode.
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <a href="monte-carlo.html?winrate=${winratePercent}&rr=${rr}" class="calculate-btn" style="display: inline-block; text-decoration: none; color: white;">Run Monte Carlo on Your Strategy</a>
                    </div>
                `;
            } else {
                // Edge Estimation: Calculate Confidence Interval for EV
                const numTradesInput = parseFloat(document.getElementById('num-trades').value);
                const ciWidthPercentInput = parseFloat(document.getElementById('ci-width').value);
                
                if (numTradesInput && numTradesInput > 0) {
                    // Calculate Confidence Interval for given number of trades
                    const seEV = (rr + 1) * Math.sqrt(variance / numTradesInput);
                    const marginOfError = z * seEV;
                    const evLower = Math.max(0, EV - marginOfError);
                    const evUpper = EV + marginOfError;
                    const actualCIWidthPercent = (marginOfError / EV) * 100;
                    
                    // Get desired Confidence Interval width (from input or default to 30%)
                    const desiredCIWidthPercent = ciWidthPercentInput && ciWidthPercentInput > 0 ? ciWidthPercentInput : 30;
                    
                    // Calculate how many trades are needed for desired Confidence Interval width
                    const marginTarget = EV * (desiredCIWidthPercent / 100);
                    const seTarget = marginTarget / z;
                    const requiredTrades = Math.ceil(Math.pow((rr + 1) * Math.sqrt(variance) / seTarget, 2));
                    
                    // Calculate actual CI for required trades
                    const seEVRequired = (rr + 1) * Math.sqrt(variance / requiredTrades);
                    const marginOfErrorRequired = z * seEVRequired;
                    const evLowerRequired = Math.max(0, EV - marginOfErrorRequired);
                    const evUpperRequired = EV + marginOfErrorRequired;
                    const actualCIWidthPercentRequired = (marginOfErrorRequired / EV) * 100;
                    
                    // Show warning if user has fewer trades than required
                    const showWarning = numTradesInput < requiredTrades;
                    
                    resultHTML = `
                        <div class="label">You need approximately</div>
                        <div class="number" id="result-number">${requiredTrades.toLocaleString()}</div>
                        <div class="label" id="result-label">trades for accurate EV estimation</div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5; font-size: 14px; color: #666;">
                            <strong>For ±${desiredCIWidthPercent}% Confidence Interval width:</strong><br>
                            <strong>Estimated EV:</strong> ${EV.toFixed(4)}<br>
                            <strong>${Math.round(selectedConfidence * 100)}% Confidence Interval:</strong> ${evLowerRequired.toFixed(4)} to ${evUpperRequired.toFixed(4)}<br>
                            <strong>Confidence Interval Width:</strong> ±${actualCIWidthPercentRequired.toFixed(2)}% (absolute: ±${marginOfErrorRequired.toFixed(4)})
                        </div>
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e5e5;">
                            <div class="label">With ${numTradesInput.toLocaleString()} trades, your EV estimate:</div>
                            <div class="number" style="font-size: 36px;">${evLower.toFixed(2)} - ${evUpper.toFixed(2)}</div>
                            <div style="margin-top: 12px; font-size: 14px; color: #666;">
                                Confidence Interval Width: ±${actualCIWidthPercent.toFixed(2)}% (absolute: ±${marginOfError.toFixed(4)})
                            </div>
                            ${showWarning ? `<div style="margin-top: 8px; font-size: 13px; color: #d97706;">⚠️ Wide Confidence Interval - you need ${requiredTrades.toLocaleString()} trades for ±${desiredCIWidthPercent}% precision</div>` : ''}
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <a href="monte-carlo.html?winrate=${winratePercent}&rr=${rr}" class="calculate-btn" style="display: inline-block; text-decoration: none; color: white;">Run Monte Carlo on Your Strategy</a>
                        </div>
                    `;
                    n = numTradesInput;
                } else if (ciWidthPercentInput && ciWidthPercentInput > 0) {
                    // Calculate required trades for desired Confidence Interval width (as percentage of EV)
                    // Desired margin of error as absolute value: margin = EV * (ciWidthPercent / 100)
                    // Confidence Interval width = 2 * z * SE, so: EV * (ciWidthPercent/100) = z * (RR+1) * sqrt(variance/n)
                    // Solving for n: n = (z * (RR+1) * sqrt(variance))² / (EV * ciWidthPercent/100)²
                    const marginTarget = EV * (ciWidthPercentInput / 100);
                    const seTarget = marginTarget / z;
                    n = Math.ceil(Math.pow((rr + 1) * Math.sqrt(variance) / seTarget, 2));
                    
                    const seEV = (rr + 1) * Math.sqrt(variance / n);
                    const marginOfError = z * seEV;
                    const evLower = Math.max(0, EV - marginOfError);
                    const evUpper = EV + marginOfError;
                    const actualCIWidthPercent = (marginOfError / EV) * 100;
                    
                    resultHTML = `
                        <div class="label">You need approximately</div>
                        <div class="number" id="result-number">${n.toLocaleString()}</div>
                        <div class="label" id="result-label">trades for accurate EV estimation</div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5; font-size: 14px; color: #666;">
                            <strong>Estimated EV:</strong> ${EV.toFixed(4)}<br>
                            <strong>${Math.round(selectedConfidence * 100)}% Confidence Interval:</strong> ${evLower.toFixed(4)} to ${evUpper.toFixed(4)}<br>
                            <strong>Confidence Interval Width:</strong> ±${actualCIWidthPercent.toFixed(2)}% (absolute: ±${marginOfError.toFixed(4)})
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <a href="monte-carlo.html?winrate=${winratePercent}&rr=${rr}" class="calculate-btn" style="display: inline-block; text-decoration: none; color: white;">Run Monte Carlo on Your Strategy</a>
                        </div>
                    `;
                } else {
                    // No input - show required trades for a default Confidence Interval width (30%)
                    const defaultCIWidthPercent = 30;
                    const marginTarget = EV * (defaultCIWidthPercent / 100);
                    const seTarget = marginTarget / z;
                    n = Math.ceil(Math.pow((rr + 1) * Math.sqrt(variance) / seTarget, 2));
                    
                    resultHTML = `
                        <div class="label">For accurate EV estimation (±30%), you need:</div>
                        <div class="number" id="result-number">${n.toLocaleString()}</div>
                        <div class="label" id="result-label">trades</div>
                        <div style="margin-top: 12px; font-size: 13px; color: #666;">
                            Enter your number of trades or desired Confidence Interval width above for a custom calculation.
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <a href="monte-carlo.html?winrate=${winratePercent}&rr=${rr}" class="calculate-btn" style="display: inline-block; text-decoration: none; color: white;">Run Monte Carlo on Your Strategy</a>
                        </div>
                    `;
                }
            }

            // Display result
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = resultHTML;
            resultDiv.classList.add('show');
            
            // Update interpretation section with actual values (only for detection mode)
            if (calculationMode === 'detection') {
                updateInterpretation(n, selectedConfidence);
            }
            
            // Mark that calculation has been done
            hasCalculated = true;

            // Scroll to result
            document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Position % symbol dynamically based on input value
        function updatePercentPosition(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            // Find the suffix for this specific input (could be winrate or ci-width)
            const inputContainer = input.closest('.input-with-suffix');
            if (!inputContainer) return;
            const suffix = inputContainer.querySelector('.input-suffix');
            if (!suffix) return;
            
            // Create a temporary span to measure text width
            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.whiteSpace = 'pre';
            tempSpan.style.fontSize = window.getComputedStyle(input).fontSize;
            tempSpan.style.fontFamily = window.getComputedStyle(input).fontFamily;
            tempSpan.style.fontWeight = window.getComputedStyle(input).fontWeight;
            tempSpan.textContent = input.value || input.placeholder || '';
            document.body.appendChild(tempSpan);
            
            // Position % right after the text + a small gap
            const textWidth = tempSpan.offsetWidth;
            document.body.removeChild(tempSpan);
            
            // Position from left: padding (14px) + text width + small gap (4px)
            const leftPosition = 14 + textWidth + 4;
            suffix.style.left = leftPosition + 'px';
        }
        
        // Setup percent positioning
        function setupPercentPositioning() {
            const winrateInput = document.getElementById('winrate');
            if (winrateInput) {
                winrateInput.addEventListener('input', () => updatePercentPosition('winrate'));
                winrateInput.addEventListener('change', () => updatePercentPosition('winrate'));
                // Initial positioning after a short delay to ensure styles are loaded
                setTimeout(() => updatePercentPosition('winrate'), 100);
            }
            
            const ciWidthInput = document.getElementById('ci-width');
            if (ciWidthInput) {
                ciWidthInput.addEventListener('input', () => updatePercentPosition('ci-width'));
                ciWidthInput.addEventListener('change', () => updatePercentPosition('ci-width'));
                setTimeout(() => updatePercentPosition('ci-width'), 100);
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupPercentPositioning();
                // Initialize field visibility based on current mode
                if (calculationMode === 'estimation') {
                    document.getElementById('ci-width-group').style.display = 'block';
                    document.getElementById('num-trades-group').style.display = 'block';
                    document.getElementById('params-group').style.display = 'none';
                    document.getElementById('ev-direction-group').style.display = 'none';
                } else {
                    document.getElementById('params-group').style.display = 'block';
                    document.getElementById('ev-direction-group').style.display = 'block';
                    document.getElementById('ci-width-group').style.display = 'none';
                    document.getElementById('num-trades-group').style.display = 'none';
                }
            });
        } else {
            setupPercentPositioning();
            // Initialize field visibility based on current mode
            if (calculationMode === 'estimation') {
                document.getElementById('ci-width-group').style.display = 'block';
                document.getElementById('num-trades-group').style.display = 'block';
                document.getElementById('params-group').style.display = 'none';
                document.getElementById('ev-direction-group').style.display = 'none';
            } else {
                document.getElementById('params-group').style.display = 'block';
                document.getElementById('ev-direction-group').style.display = 'block';
                document.getElementById('ci-width-group').style.display = 'none';
                document.getElementById('num-trades-group').style.display = 'none';
            }
        }

        // Allow Enter key to calculate
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                // Only handle Enter if it's in an input field (not in textarea, etc.)
                const target = e.target;
                if (target.tagName === 'INPUT' && target.type !== 'textarea') {
                    e.preventDefault();
                    calculate();
                    // Ensure scroll happens after DOM update
                    setTimeout(() => {
                        const resultDiv = document.getElementById('result');
                        if (resultDiv && resultDiv.classList.contains('show')) {
                            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }, 50);
                }
            }
        });
    </script>
    <!-- Vercel Analytics -->
    <script>
        // Vercel Analytics for static HTML sites
        // Note: Analytics only sends data in production, not in development
        (function() {
            if (typeof window === 'undefined') return;
            
            // Use Vercel's analytics endpoint (works in production)
            var script = document.createElement('script');
            script.src = '/_vercel/insights/script.js';
            script.defer = true;
            script.onerror = function() {
                // Fallback: if Vercel endpoint doesn't work, try the CDN
                var fallback = document.createElement('script');
                fallback.src = 'https://va.vercel-scripts.com/v1/script.js';
                fallback.defer = true;
                document.head.appendChild(fallback);
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>

